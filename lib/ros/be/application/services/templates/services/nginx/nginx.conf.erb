server {
  server_name _;

  # upstream uses a variable so nginx will still start even if the host is not reachable
  # so we need to include the internal Docker DNS to resolve the name to IP when host comes up
  # valid values sets the name cache validity time
  # See: https://sandro-keil.de/blog/let-nginx-start-if-upstream-host-is-unavailable-or-down/
  resolver 127.0.0.11 valid=30s;

  location /healthz {
    return 200 'no content';
  }<% nginx_services.each do |name| %>

  location /<%= name %>/ {
    add_header Access-Control-Expose-Headers 'Authorization';
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    set $upstream http://<%= name %>:3000/;
    proxy_pass $upstream;
  }<% end %>
}
